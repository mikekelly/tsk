name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.5.0)'
        required: true

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-linux
            artifact: dot-linux-x86_64
          - os: macos-14
            target: aarch64-macos
            artifact: dot-macos-arm64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build Release
        run: |
          zig build -Doptimize=ReleaseSmall
          strip zig-out/bin/dot || true
          mv zig-out/bin/dot ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      macos_sha256: ${{ steps.sha256.outputs.macos }}
      linux_sha256: ${{ steps.sha256.outputs.linux }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          mv artifacts/dot-linux-x86_64/dot-linux-x86_64 release/
          mv artifacts/dot-macos-arm64/dot-macos-arm64 release/
          chmod +x release/*
          ls -la release/

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Calculate SHA256
        id: sha256
        run: |
          echo "macos=$(sha256sum release/dot-macos-arm64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux=$(sha256sum release/dot-linux-x86_64 | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: dots ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            release/dot-linux-x86_64
            release/dot-macos-arm64
          body: |
            ## What's New

            Major rewrite: SQLite replaced with plain markdown files.
            - **107x smaller binary** (25MB → 233KB)
            - **41x less code** (115k → 2.8k LOC)
            - **Zero dependencies** - no database, no runtime requirements
            - **Portable storage** - copy `.dots/` folder anywhere

            ## Installation

            ### Homebrew (macOS ARM64, Linux x86_64)
            ```bash
            brew install joelreymont/tap/dots
            ```

            ### Manual download
            ```bash
            # Linux x86_64
            curl -L -o dot https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/dot-linux-x86_64
            chmod +x dot
            sudo mv dot /usr/local/bin/

            # macOS ARM64
            curl -L -o dot https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/dot-macos-arm64
            chmod +x dot
            sudo mv dot /usr/local/bin/
            ```

            ## Migrating from beads

            If you have existing tasks in `.beads/beads.db`:
            ```bash
            ./migrate-dots.sh
            ```

            ## Verify
            ```bash
            dot --version
            ```

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: joelreymont/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        run: |
          TAG="${{ needs.release.outputs.tag }}"
          VERSION="${TAG#v}"
          MACOS_SHA="${{ needs.release.outputs.macos_sha256 }}"
          LINUX_SHA="${{ needs.release.outputs.linux_sha256 }}"

          cat > Formula/dots.rb << 'FORMULA'
          class Dots < Formula
            desc "Minimal task tracker for AI agents - plain markdown files, no database"
            homepage "https://github.com/joelreymont/dots"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/joelreymont/dots/releases/download/TAG_PLACEHOLDER/dot-macos-arm64"
                sha256 "MACOS_SHA_PLACEHOLDER"
              end
              on_intel do
                odie "Intel Mac binaries not available. Please build from source."
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/joelreymont/dots/releases/download/TAG_PLACEHOLDER/dot-linux-x86_64"
                sha256 "LINUX_SHA_PLACEHOLDER"
              end
            end

            def install
              binary_name = if OS.mac? && Hardware::CPU.arm?
                "dot-macos-arm64"
              elsif OS.linux? && Hardware::CPU.intel?
                "dot-linux-x86_64"
              end
              bin.install binary_name => "dot" if binary_name
            end

            test do
              assert_match "dots", shell_output("#{bin}/dot --version")
            end
          end
          FORMULA

          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" Formula/dots.rb
          sed -i "s/TAG_PLACEHOLDER/$TAG/g" Formula/dots.rb
          sed -i "s/MACOS_SHA_PLACEHOLDER/$MACOS_SHA/g" Formula/dots.rb
          sed -i "s/LINUX_SHA_PLACEHOLDER/$LINUX_SHA/g" Formula/dots.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/dots.rb
          git commit -m "Update dots to ${{ needs.release.outputs.tag }}"
          git push
